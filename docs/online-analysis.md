# 在线与闭环分析系统

在线分析系统是NNSR的重要组成部分，专门用于实时处理来自DBS设备的电生理数据。该系统支持实时特征提取、在线信号处理和基于特征的反馈控制，为闭环脑机接口研究提供技术支撑。

## 系统概述

### 核心功能
- **实时数据采集**：与DBS设备通过安全协议通信以获取LFP数据
- **在线信号处理**：快速的实时信号处理
- **特征实时提取**：支持多种特征的在线计算
- **反馈控制**：基于特征的实时反馈和控制

### 技术特点
- **低延迟安全传输层**：在蓝牙传输基础上，平均延迟增量仅1.32±0.37ms
- **安全通信协议**：加密数据传输确保患者安全
- **多模态并行**：支持多通道与多模态数据同时处理
- **可扩展架构**：支持自定义算法集成

## 设备连接与配置

### 连接设置

#### 串口连接配置
1. **串口查询**：自动检测可用串口
2. **串口选择**：选择对应的通信端口
3. **连接建立**：打开串口并建立通信

#### 蓝牙连接配置（需要专用转发server，请联系作者获取）
1. **蓝牙模块初始化**：初始化PC端蓝牙适配器
2. **设备配对**：输入设备地址进行配对
3. **连接验证**：连接稳定性

### 采集参数设置

#### 基本采集参数
- **采样频率**：250Hz、500Hz、1000Hz、同步采集等可选
- **采集时间**：设置单次采集的时长
- **通道选择**：选择参与采集的电极通道
- **采集模式**：单极或双极差分模式

## 实时数据采集

### 数据获取流程

#### 采集初始化
1. **参数确认**：向设备发送采集参数
2. **开始采集**：发送采集开始指令
3. **实时监控**：监控数据传输状态

#### 数据流管理
- **流式接收**：连续接收实时数据流
- **缓冲管理**：智能缓冲区管理避免数据丢失
- **质量监控**：实时监控数据质量和完整性

### 实时显示

#### 时域波形显示
- **多通道显示**：同时显示多个通道的实时波形
- **自动缩放**：根据信号幅度自动调整显示范围
- **滚动显示**：实时滚动更新的波形显示

#### 数据质量指标
- **噪声水平**：监控背景噪声水平
- **连接状态**：设备连接状态实时指示

## 在线信号处理

### 实时滤波

#### 实时滤波器
- **带通滤波**：实时去除带外噪声
- **陷波滤波**：去除工频干扰
- **自适应滤波**：根据信号特性自适应调整

#### 滤波器配置
- **滤波器类型**：IIR、FIR滤波器选择
- **截止频率**：可调节的滤波器参数
- **实时响应**：零相位延迟的实时滤波

### 在线伪迹处理

#### 刺激伪迹实时去除
- **模板检测**：实时检测刺激脉冲
- **自适应减除**：基于模板的实时减除
- **参数调整**：根据刺激参数动态调整

## 实时特征提取

### 时域特征

#### 统计特征
- **均值方差**：滑动窗口统计特征
- **峰值检测**：实时峰值检测和计数
- **过零率**：信号过零率的实时计算
- **自定义接口**：自定接口以适配各类特征统计

### 频域特征

#### 功率谱分析
- **实时PSD**：基于滑动窗口的功率谱估计
- **频段能量**：特定频段功率的实时计算
- **主频检测**：信号主频的实时识别

#### 频段比值
- **β/γ比值**：帕金森病相关的频段比值
- **相对功率**：各频段相对功率计算
- **频谱重心**：功率谱重心频率

### 时频特征

#### 短时傅里叶变换
- **实时STFT**：滑动窗口的时频分析
- **时频图更新**：实时更新时频能量分布
- **特征频段追踪**：特定频段能量的时间演化

## 反馈控制系统

### β频段能量反馈

#### 实时β能量计算
- **频段定义**：13-30Hz β频段功率计算
- **归一化处理**：相对于总功率的归一化
- **平滑滤波**：减少瞬时波动的影响

#### 反馈显示
- **能量条**：β频段能量的实时条形图显示
- **趋势图**：β能量随时间的变化趋势
- **阈值指示**：可设置的阈值线显示

### 外部设备控制

#### 同步触发
- **触发信号输出**：向外部设备发送同步信号
- **事件标记**：在数据流中标记特定事件

#### 闭环控制接口
- **控制信号输出**：基于特征的控制信号生成
- **参数调制**：实时调整刺激参数
- **安全机制**：多重安全检查确保患者安全

## 数据记录与存储

### 实时数据记录

#### 连续记录
- **自动存储**：采集数据的自动存储
- **文件管理**：按时间自动创建数据文件
- **格式选择**：多种存储格式可选

#### 事件记录
- **手动标记**：手动添加事件标记
- **自动标记**：基于算法的自动事件检测
- **同步记录**：事件与数据的精确时间同步

## 扩展接口

### 同步扩展

#### 多设备同步
- **时间同步**：多设备间的时间同步
- **数据对齐**：不同数据流的时间对齐（基于获取时刻与先验补偿）
- **同步验证**：同步精度的实时验证

#### 外部设备接口
- **串口通信**：与外部设备的串口通信或内部虚拟串口
- **TCP/IP接口**：网络设备的数据交换

### 可视化扩展

#### 基准屏显示
- **全屏显示**：专用显示屏的全屏反馈
- **自定义界面**：可定制的反馈界面
- **实时更新**：反馈信息的实时更新

#### 第三方集成
- **数据流输出**：向第三方软件输出数据流
- **插件系统**：支持第三方插件集成

在线分析系统为DBS闭环控制和实时脑机接口研究提供了强大的技术平台，确保了研究的安全性、实时性和可靠性。

